# Variable 'LOCATION' was defined in the Variables tab
# Variable 'ORACLE_HOST' was defined in the Variables tab
# Variable 'ORACLE_PASS' was defined in the Variables tab
# Variable 'ORACLE_PORT' was defined in the Variables tab
# Variable 'ORACLE_SID' was defined in the Variables tab
# Variable 'ORACLE_USER' was defined in the Variables tab
# Agent Queue 'Azure Pipelines' was used with unrecognized Agent Specification, vmImage property must be specified to determine image - https://docs.microsoft.com/en-us/azure/devops/pipelines/agents/hosted?view=azure-devops&tabs=yaml#software
# Agent Queue 'Azure Pipelines' was used with unrecognized Agent Specification, vmImage property must be specified to determine image - https://docs.microsoft.com/en-us/azure/devops/pipelines/agents/hosted?view=azure-devops&tabs=yaml#software
variables:
- name: BuildParameters.RestoreBuildProjects
  value: '**/*.csproj'
- name: BuildParameters.TestProjects
  value: '**/*[Tt]ests/*.csproj'
trigger:
  branches:
    include:
    - refs/heads/main
name: $(date:yyyyMMdd)$(rev:.r)
jobs:
- job: Job_2
  displayName: Criar Infra Inicial
  pool:
    name: Azure Pipelines
  steps:
  - checkout: self
    fetchDepth: 1
  - task: AzureCLI@2
    displayName: Banco e Azure
    inputs:
      connectedServiceNameARM: 9668492c-9d55-4134-9d68-a078f19519bb
      scriptType: bash
      scriptPath: scripts/script-infra-app.sh
      scriptArguments: -ORACLE_HOST oracle.fiap.com.br -ORACLE_PORT 1521 -ORACLE_SID ORCL -ORACLE_USER rm558515 -ORACLE_PASS Fiap#2025 -LOCATION brazilsouth
- job: Job_1
  displayName: Build and Test
  dependsOn: Job_2
  pool:
    name: Azure Pipelines
  steps:
  - checkout: self
    fetchDepth: 1
  - task: DotNetCoreCLI@2
    displayName: Restore
    inputs:
      command: restore
      projects: $(BuildParameters.RestoreBuildProjects)
  - task: DotNetCoreCLI@2
    displayName: Build
    inputs:
      projects: $(BuildParameters.RestoreBuildProjects)
      arguments: --configuration $(BuildConfiguration)
  - task: DotNetCoreCLI@2
    displayName: Test
    inputs:
      command: test
      projects: $(BuildParameters.TestProjects)
      arguments: --configuration $(BuildConfiguration) --logger "trx;LogFileName=test-results.trx" --results-directory "$(Agent.TempDirectory)/TestResults"
      testRunTitle: Testes de CURD
  - task: PublishTestResults@2
    displayName: Publish Test Results
    inputs:
      testRunner: VSTest
      testResultsFiles: '**/TestResults/**/*.trx'
      mergeTestResults: true
  - task: DotNetCoreCLI@2
    displayName: Publish
    inputs:
      command: publish
      publishWebProjects: True
      projects: $(BuildParameters.RestoreBuildProjects)
      arguments: --configuration $(BuildConfiguration) --output $(build.artifactstagingdirectory)
      zipAfterPublish: True
  - task: PublishBuildArtifacts@1
    displayName: Publish Artifact
    inputs:
      PathtoPublish: $(build.artifactstagingdirectory)
      ArtifactName: app
      TargetPath: '\\my\share\$(Build.DefinitionName)\$(Build.BuildNumber)'
...