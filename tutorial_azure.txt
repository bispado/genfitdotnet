Azure Pipelines API .NET com Oracle
1. Criar um novo projeto no Azure DevOps

Para iniciar, vamos criar um novo projeto no Azure DevOps.
Criar novo projeto

Nome do projeto: Pricewhisper

Descrição: Projeto para otimizar a precificação de produtos no setor varejista, utilizando análise de dados e machine learning para fornecer insights estratégicos

Visibilidade: Private

Controle de versão: Git

Processo de item de trabalho: Agile

2. Importar o projeto do GitHub para o Azure Repos

Agora vamos importar o projeto que está no GitHub para o Azure Repos.
https://github.com/profjoaomenk/pricewhisper-api-dotnet-oracle.git
Importar um repositório Git

Tipo de repositório: Git

URL de clone: https://github.com/profjoaomenk/pricewhisper-api-dotnet-oracle

Requer autenticação: (desmarcado)

Nome: pricewhisper-api-dotnet-oracle

3. Analisar o Código do Projeto

Analise o Código do Projeto juntamente com seu Professor.
No Visual Studio Code, observe a estrutura do projeto, as referências e a conexão com o Oracle no arquivo appsettings.json.

4. Criar uma Conexão de Serviço (Service Connection)

Agora que temos o Projeto criado e seu código fonte, vamos criar uma Conexão de Serviço (Service Connection) com a nossa assinatura do Azure.

No menu lateral, em "Pipelines", clique em "Service connections".

Clique em "Create service connection".

5. Configurar a Conexão de Serviço com Azure Resource Manager

Escolha Azure Resource Manager como o Service connection e o configure para sua assinatura da Azure.
Nova conexão de serviço do Azure

Tipo de identidade: App registration (automatic) (Deixe o padrão)

Credencial: Workload identity federation (Deixe o padrão)

Nível do escopo: Subscription

Assinatura: pf0841s1 - Azure para Estudantes (Sua assinatura)

Nome da Conexão de Serviço: MyAzureSubscription

Descrição: Credenciais para minha assinatura da Azure

Segurança: Grant access permission to all pipelines (Todas as Pipelines podem acessar esse Serviço)
Clique em "Save".

6. Verificar a Conexão de Serviço Criada

Service connection criado.
Verifique os detalhes da conexão, como o tipo (Azure Resource Manager), o criador e a descrição.

7. Criar uma Pipeline de CI (Build)

Agora sim podemos começar a criar nossa Pipeline CI/CD. Vamos começar com a nossa Pipeline de CI (Build).
Acesse Pipelines e clique em Create Pipeline para começarmos.

No menu lateral, clique em "Pipelines".

Clique em "Create Pipeline".

8. Utilizar o Classic Editor

Utilize o Classic Editor para essa Pipeline.

Na tela "Where is your code?", clique em "Use the classic editor".

9. Escolher o Repositório do Projeto

Escolha o Repositório do Projeto que acabamos de importar.

Em "Select a source", selecione "Azure Repos Git".

Em "Team project", selecione Pricewhisper.

Em "Repository", selecione pricewhisper-api-dotnet-oracle.

Em "Default branch for manual and scheduled builds", selecione master.
Clique em "Continue".

10. Selecionar o Template ASP.NET Core

Procure pelo Template: ASP.NET Core e selecione.

Na caixa de busca, digite "ASP.NET Core".

Selecione o template "ASP.NET Core" e clique em "Apply".

11. Adaptar o Template Criado

Template criado, agora podemos realizar as adaptações necessárias.
Você verá uma pipeline com as tarefas de Restore, Build, Test e Publish.

12. Informar as Propriedades da Pipeline de CI

Vamos começar a informar as propriedades da nossa Pipeline de CI.
Informe um novo nome para nossa Pipeline e como será o ambiente de execução do CI.

No campo "Name", altere para Pricewhisper-CI.

Em "Agent Specification", selecione windows-2025.

13. Renomear o Job para "Build and Test"

O nome do nosso Job pode ficar como: Build and Test.

Clique no "Agent job".

No campo "Display name", altere para Build and Test.

14. Configurar a Task Restore

A Task Restore não iremos atualizar, aceitaremos os padrões oferecidos.
Verifique que a "Task version" é 2.* e o "Command" é restore.

15. Configurar a Task Build

Na Task Build só iremos atualizar a precedência de execução.

Em "Control Options", habilite "Only when all previous tasks have succeeded".

16. Configurar a Task Test

Na Task Test iremos apenas adicionar um título para os testes realizados e a precedência de execução.

Em "Publish test results and code coverage", no campo "Test run title", adicione Testes de CRUD.

Em "Control Options", habilite "Only when all previous tasks have succeeded".

17. Configurar a Task Publish

Na Task Publish só iremos atualizar a precedência de execução.

Em "Control Options", habilite "Only when all previous tasks have succeeded".

18. Configurar a Task Publish Artifact

Na Task Publish Artifact só iremos alterar o nome do Artefato e atualizar a precedência de execução.

Em "Artifact name", altere para app.

Em "Control Options", habilite "Only when all previous tasks have succeeded".

19. Adicionar um Agent Job para Infra

Agora que temos o CI completo e configurado vamos incluir outra execução do Agent, uma Etapa para criar a Infra necessária do Projeto, caso seja necessário.
Clique na Pipeline e adicione um Agent job.

Clique em "Pipeline".

Clique em "Add an agent job".

20. Arrastar o Agent Job para o início

Arraste esse Job para ser o primeiro na lista.
Arraste o bloco "Agent job" para cima, antes de "Build and Test".

21. Configurar o Novo Agent Job

Clique no Agent job criado e altere seu nome e a execução do Job.

Clique no "Agent job" recém-adicionado.

Em "Display name", altere para Criar Infra Inicial.

Em "Agent Specification", selecione ubuntu-24.04.

22. Incluir a Tarefa Azure CLI

Agora vamos incluir uma nova tarefa para essa Etapa, a tarefa do Azure CLI.
Clique no sinal de + no Agent Job criado, procure por CLI e clique no botão Add.

Clique no sinal de + ao lado de "Criar Infra Inicial".

Na caixa de busca, digite "CLI".

Selecione "Azure CLI" e clique em "Add".

23. Configurar as Propriedades da Tarefa Azure CLI

Pronto, incluímos uma nova Tarefa em uma Etapa. Selecione a nova Tarefa e altere as propriedades conforme abaixo.

Clique na tarefa "Azure CLI".

Em "Display name", altere para Banco e Azure.

Em "Azure Resource Manager connection", selecione MyAzureSubscription.

Em "Script Type", selecione Shell.

Em "Script path", procure o script no Repositório: pricewhisper-usuarios.API/infra-app.sh.

Em "Script Arguments", adicione: $(ORACLE_HOST) $(ORACLE_PORT) $(ORACLE_SID) $(ORACLE_USER) $(ORACLE_PASS)

24. Incluir a Dependência entre as Etapas

Agora só falta incluir a dependência entre as Etapas, primeiro a Infra inicial.

Clique no "Build and Test".

Em "Dependencies", clique no sinal de + e selecione Criar Infra Inicial.

Em "Control Options", habilite "Only when all previous jobs have succeeded".

25. Definir Variáveis de Ambiente

Vamos definir nossas Variáveis de Ambiente na sessão Variables.

Clique em "Variables".

Em "Pipeline variables", adicione as seguintes variáveis e marque "Settable at queue time":

ASPNETCORE_ENVIRONMENT: Development

OracleConnection: (valor da sua string de conexão Oracle, exemplo: Data Source=your_datasource; User ID=your_username; Password=your_password;)

ORACLE_HOST: oracle.fiap.com.br

ORACLE_PASS: ******** (sua senha)

ORACLE_PORT: 1521

ORACLE_SID: ORCL

ORACLE_USER: pf0841

LOCATION: brazilsouth

26. Habilitar a Integração Contínua

Na aba Triggers habilite a Integração Contínua.

Clique em "Triggers".

Marque a opção "Enable continuous integration".

Em "Branch filters", adicione "Include" na branch master.

27. Salvar e Executar a Pipeline de CI

Salve e execute a Pipeline de CI - Verifique se existem parâmetros em Run Time.

Clique em "Save and run".

Verifique os parâmetros de Run Time, como o agente (windows-2025) e a branch (master).

28. Analisar o Resultado da Pipeline de Build (CI)

Analise o resultado da Pipeline de Build (CI).
Verifique o "Summary", "Tests" e "Code Coverage".
Observe o status dos "Jobs": Criar Infra Inicial (Success) e Build and Test (Success).

29. Criar uma Nova Pipeline de Release

Crie uma nova Pipeline de Release escolhendo o Template: Azure App Service deployment.

No menu lateral, clique em "Releases".

Clique em "New pipeline".

Selecione o template "Azure App Service deployment" e clique em "Apply".

30. Definir Propriedades da Pipeline de Release

Vamos começar a definir as propriedades da Pipeline de Release começando pelo nome da Pipeline e depois alterando o nome do Stage.

Clique em "New release pipeline" e altere para Deploy em Dev.

Clique no "Stage 1" e altere o "Stage name" para Deploy em Dev.

Clique em "1 job, 1 task".

31. Configurar as Propriedades da Pipeline

Deixe as propriedades conforme abaixo em nossa Pipeline.

Stage name: Deploy em Dev

Azure subscription: MyAzureSubscription

App type: Web App on Windows

App service name: api-dotnet-rm9999

32. Configurar as Propriedades do Agente

Deixe as propriedades conforme abaixo no Agente.

Display name: Deploy no Serviço de Aplicativo

Agent pool: Azure Pipelines

Agent Specification: windows-2025

33. Configurar as Propriedades da Task de Deploy

Deixe as propriedades conforme abaixo na Task de Deploy.

Display name: Deploy no Serviço de Aplicativo

Connection type: Azure Resource Manager

Azure subscription: MyAzureSubscription

App Service type: (não especificado na imagem, manter o padrão se necessário)

Package or folder: $(System.DefaultWorking Directory)/**/*.zip

App settings: -ASPNETCORE_ENVIRONMENT $(ASPNETCORE_ENVIRONMENT) -ConnectionStrings_OracleConnection "$(OracleConnection)"

34. Incluir Variáveis na Pipeline de Release

Agora, na parte de Variáveis, vamos incluir as utilizadas nessa Pipeline.

Clique em "Variables".

Adicione as variáveis: ASPNETCORE_ENVIRONMENT (Value: Development, Scope: Release) e OracleConnection (Value: ********, Scope: Release).

35. Adicionar um Artefato

Com o Stage pronto clique em Add an artifact e escolha o Repositório do nosso Projeto.

Clique em "Add an artifact".

Em "Source type", selecione "Build".

Em "Project", selecione Pricewhisper.

Em "Source (build pipeline)", selecione Pricewhisper-CI.

Em "Default version", selecione Latest.

Em "Source alias", altere para Pricewhisper-CI.
Clique em "Add".

36. Habilitar o Continuous Deployment

Habilite o Continuous deployment.

Clique no ícone de "Continuous deployment trigger" no artefato adicionado.

Habilite "Enabled".

Em "Build branch filters", adicione "Include" na branch master.

37. Salvar e Criar um Release

Salve a Pipeline de Release e depois Crie um Release.

Clique em "Save".

Clique em "Create release".

38. Aguardar a Execução da Pipeline de Release

Aguarde a execução da Pipeline de Release.
Acompanhe o status do Deploy em Dev.

39. Analisar os Resultados do Logs

Analise os resultados do Logs.
Verifique o "Deployment process" e o tempo de execução de cada etapa: Initialize job, Download artifact, Deploy no Serviço de Aplicativo e Finalize Job.

40. Executar a API pelo Link do Serviço de Aplicativo

Execute a API pelo Link do Serviço de Aplicativo.
Abra o link api-dotnet-rm9999.azurewebsites.net (substitua pelo seu).

41. Incluir uma Nova Rota em Program.cs para Testar

Para testar o CI/CD completo, vamos incluir uma nova rota em Program.cs.

code
C#
download
content_copy
expand_less
// Rota incluída - API somente GET em /wellcome
app.MapGet("/wellcome", () => Results.Text("Rota adicionada"))
    .WithName("Wellcome")
    .WithTags("Health")
    .Produces<string>(StatusCodes.Status2000K);
42. Acompanhar a Pipeline de CI e CD após o Commit

Após o commit, acompanhe a Pipeline de CI e a Pipeline de CD.
Verifique que uma nova execução da pipeline de CI e CD foi disparada.

43. Testar a Nova Rota

Inclua o Sufixo /wellcome na URL do seu App para testar.
https://api-dotnet-rm9999.azurewebsites.net/wellcome (substitua pelo seu).
Você deverá ver a mensagem "Rota adicionada".
Ou utilize o Link do Swagger e execute o GET /wellcome no grupo "Health".

44. Limpar Laboratório na Azure

Delete todos os Recursos no Portal utilizados nesse exercício.

Verifique se não sobrou nenhum Recurso dos nossos Deploys.
drop table "Usuarios";
drop table "Empresas";